<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.eventapp.repository.ParticipationRepository">

    <resultMap id="ParticipationResultMap" type="com.example.eventapp.model.Participation">
        <id property="id" column="id"/>
        <result property="eventId" column="event_id"/>
        <result property="participantName" column="participant_name"/>
        <result property="participantEmail" column="participant_email"/>
        <result property="participantPhone" column="participant_phone"/>
        <result property="registeredAt" column="registered_at"/>
    </resultMap>

    <!-- イベントIDによる参加者一覧取得 -->
    <select id="findByEventId" parameterType="long" resultMap="ParticipationResultMap">
        SELECT 
            id, event_id, participant_name, participant_email, 
            participant_phone, registered_at
        FROM participation
        WHERE event_id = #{eventId}
        ORDER BY registered_at ASC
    </select>

    <!-- 参加登録 -->
    <insert id="insert" parameterType="com.example.eventapp.model.Participation" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO participation (
            event_id, participant_name, participant_email, 
            participant_phone, registered_at
        ) VALUES (
            #{eventId}, #{participantName}, #{participantEmail}, 
            #{participantPhone}, #{registeredAt}
        )
    </insert>

    <!-- 重複参加チェック -->
    <select id="findByEventIdAndEmail" resultMap="ParticipationResultMap">
        SELECT 
            id, event_id, participant_name, participant_email, 
            participant_phone, registered_at
        FROM participation
        WHERE event_id = #{eventId} AND participant_email = #{email}
    </select>

    <!-- 参加キャンセル -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM participation WHERE id = #{id}
    </delete>

    <!-- イベントの参加者数カウント -->
    <select id="countByEventId" parameterType="long" resultType="int">
        SELECT COUNT(*) FROM participation WHERE event_id = #{eventId}
    </select>

</mapper>